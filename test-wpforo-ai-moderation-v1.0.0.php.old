<?php
/**
 * Plugin Name: Test LLM Moderator for wpForo
*Description: AI-powered moderation using OpenRouter with standalone Moderator/Admin interface

* Version: 1.0.0
* Requires Plugins: wpforo-ai-moderation
* Author: comingofflais.com
 * WPForo AI Moderation - Test Interface
 * 
 * Admin-level interface for testing different scenarios with full-width cards
 * Cards are saved to server storage (database) rather than cache or browser memory
 * 
 * 
 * 
 * 
 */

// Register admin menu
add_action('admin_menu', function () {
    add_menu_page(
        'AI Moderation Test Interface',          
        'AI Moderation Test', 
        'wpforo_ai_can_access_moderation',               
        'wpforo-ai-moderation-test',               
        'wpforo_ai_test_interface',   
        'dashicons-admin-generic',
        35
    );
});





/**
 * 
 * 
 * 
 * GUI SECTION
 * 
 * 
 * 
 */
// Main test interface function
function wpforo_ai_test_interface() {
    // Prevent direct access
    if (!defined('ABSPATH')) {
        exit;
    }

    // Check if user has admin capabilities
    if (!current_user_can('manage_options') && !current_user_can('wpforo_ai_can_access_moderation')) {
        wp_die('You do not have sufficient permissions to access this page.');
    }

    // Handle form submissions
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        // Handle add card
        if (isset($_POST['add_card']) && !empty($_POST['card_title'])) {
            wpforo_ai_test_save_card(sanitize_text_field($_POST['card_title']));
        }
        
        // Handle delete card
        if (isset($_POST['delete_card']) && !empty($_POST['card_id'])) {
            wpforo_ai_test_delete_card(sanitize_text_field($_POST['card_id']));
        }
        
        // Handle update card
        if (isset($_POST['update_card']) && !empty($_POST['card_id'])) {
            $card_data = [
                'title_content' => isset($_POST['title_content']) ? sanitize_text_field($_POST['title_content']) : '',
                'post_content' => isset($_POST['post_content']) ? sanitize_text_field($_POST['post_content']) : '',
                'type' => isset($_POST['type']) ? sanitize_text_field($_POST['type']) : 'topic',
                'approve' => isset($_POST['approve']) ? 1 : 0,
                'delete_user' => isset($_POST['delete_user']) ? 1 : 0,
                'delete_content' => isset($_POST['delete_content']) ? 1 : 0,
                'unmute' => isset($_POST['unmute']) ? sanitize_text_field($_POST['unmute']) : 'manually'
            ];
            
            wpforo_ai_test_update_card(
                sanitize_text_field($_POST['card_id']),
                $card_data
            );
        }
    }

    // Get all saved cards
    $saved_cards = wpforo_ai_test_get_cards();
?>
<div class="wrap">
    <h1>WPForo AI Moderation - Test Interface</h1>
    
    <?php if (isset($_POST['add_card']) && !empty($_POST['card_title'])): ?>
        <div class="notice notice-success is-dismissible">
            <p>Card added successfully!</p>
        </div>
    <?php elseif (isset($_POST['delete_card'])): ?>
        <div class="notice notice-success is-dismissible">
            <p>Card deleted successfully!</p>
        </div>
    <?php elseif (isset($_POST['update_card'])): ?>
        <div class="notice notice-success is-dismissible">
            <p>Card updated successfully!</p>
        </div>
    <?php endif; ?>
    
    <!-- Add Card Form -->
    <div class="card" style="margin-bottom: 20px; padding: 20px; background: #fff; border: 1px solid #ccd0d4;">
        <h2>Add New Test Card</h2>
        <form method="post" style="display: flex; gap: 10px; align-items: center;">
            <input type="text" 
                   name="card_title" 
                   placeholder="Enter card title..." 
                   style="flex: 1; padding: 8px; font-size: 14px;"
                   required>
            <button type="submit" 
                    name="add_card" 
                    class="button button-primary"
                    style="padding: 8px 20px;">
                Add Card
            </button>
        </form>
    </div>
    
    <!-- Display Saved Cards -->
    <div class="cards-container">
        <?php if (empty($saved_cards)): ?>
            <div class="card" style="padding: 40px; text-align: center; background: #f9f9f9; border: 1px dashed #ccd0d4;">
                <h3>No cards yet</h3>
                <p>Add your first test card using the form above.</p>
            </div>
        <?php else: ?>
            <?php foreach ($saved_cards as $card_id => $card): ?>
                <div class="card" style="margin-bottom: 20px; background: #fff; border: 1px solid #ccd0d4; border-radius: 4px;">
                    <!-- Card Header with Title -->
                    <div style="padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #e5e5e5;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">
                                <?php echo esc_html($card['title']); ?>
                            </h3>
                            <form method="post" style="margin: 0;">
                                <input type="hidden" name="card_id" value="<?php echo esc_attr($card_id); ?>">
                                <button type="submit" 
                                        name="delete_card" 
                                        class="button button-link button-link-delete"
                                        onclick="return confirm('Are you sure you want to delete this card?')"
                                        style="color: #dc3232;">
                                    Delete
                                </button>
                            </form>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            Created: <?php echo esc_html($card['created']); ?> | 
                            Modified: <?php echo esc_html($card['modified']); ?>
                        </div>
                    </div>
                    
                    <!-- Card Body - Horizontal Layout -->
                    <div style="padding: 15px;">
                        <form method="post" style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;" class="moderation-form" data-original-values='<?php echo htmlspecialchars(json_encode($card['content']), ENT_QUOTES, 'UTF-8'); ?>'>
                            <input type="hidden" name="card_id" value="<?php echo esc_attr($card_id); ?>">

                            <!-- Content Input--> 
                            <div style="display: flex; align-items: left; gap: 5px;">
                                <label>Title Content: <input type="text" name="title_content" value="<?php echo esc_attr($card['content']['title_content']); ?>" class="form-field" placeholder="[FLAG] | [REVIEW] | [ALLOW]"></label>
                                <label>Body Content: <input type="text" name="post_content" value="<?php echo esc_attr($card['content']['post_content']); ?>" class="form-field" placeholder="[FLAG] | [REVIEW] | [ALLOW]"></label>
                            </div>
                            
                            <!-- Type dropdown -->
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label style="font-weight: 600; white-space: nowrap;">Type:</label>
                                <select name="type" style="padding: 6px; border: 1px solid #ddd; border-radius: 3px; min-width: 120px;" class="form-field">
                                    <option value="topic" <?php selected($card['content']['type'], 'topic'); ?>>Topic</option>
                                    <option value="post" <?php selected($card['content']['type'], 'post'); ?>>Post</option>
                                    <option value="topic-edit" <?php selected($card['content']['type'], 'topic-edit'); ?>>Topic-edit</option>
                                    <option value="post-edit" <?php selected($card['content']['type'], 'post-edit'); ?>>Post-edit</option>
                                </select>
                            </div>
                            
                            <!-- Checkboxes section -->
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                                    <input type="checkbox" name="approve" value="1" <?php checked($card['content']['approve'], 1); ?> class="form-field">
                                    Approve
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                                    <input type="checkbox" name="delete_user" value="1" <?php checked($card['content']['delete_user'], 1); ?> class="form-field">
                                    Delete User
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                                    <input type="checkbox" name="delete_content" value="1" <?php checked($card['content']['delete_content'], 1); ?> class="form-field">
                                    Delete Content
                                </label>
                            </div>
                            
                            <!-- Unmute dropdown -->
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label style="font-weight: 600; white-space: nowrap;">Unmute:</label>
                                <select name="unmute" style="padding: 6px; border: 1px solid #ddd; border-radius: 3px; min-width: 120px;" class="form-field">
                                    <option value="manually" <?php selected($card['content']['unmute'], 'manually'); ?>>Manually</option>
                                    <option value="automatically" <?php selected($card['content']['unmute'], 'automatically'); ?>>Automatically</option>
                                </select>
                            </div>
                            
                            <!-- Save button and card ID -->
                            <div style="display: flex; align-items: center; gap: 10px; margin-left: auto;">
                                <button type="submit" 
                                        name="update_card" 
                                        class="button button-primary save-button"
                                        style="padding: 6px 12px;">
                                    Save
                                </button>
                                <button type="button" 
                                        name="run_test" 
                                        class="button button-secondary run-test-button"
                                        style="padding: 6px 12px;"
                                        data-card-id="<?php echo esc_attr($card_id); ?>">
                                    Run Test
                                </button>
                                <span class="unsaved-changes-indicator" style="display: none; color: #dc3232; font-size: 11px; white-space: nowrap; font-weight: bold; background: #ffeaea; padding: 2px 6px; border-radius: 3px; border: 1px solid #dc3232;">
                                    ‚ö†Ô∏è Changes not saved
                                </span>
                                <span style="font-size: 11px; color: #666; white-space: nowrap;">
                                    ID: <?php echo esc_html($card_id); ?>
                                </span>
                            </div>
                        </form>
                        
                        <!-- Test Results Display -->
                        <div class="test-results" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e5e5e5; display: <?php echo !empty($card['test_results']) ? 'block' : 'none'; ?>;">
                            <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #646970;">Test Results</h4>
                            <?php if (!empty($card['test_results'])): ?>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <span style="font-weight: bold; color: <?php echo $card['test_results']['success'] ? '#46b450' : '#dc3232'; ?>;">
                                            <?php echo $card['test_results']['success'] ? '‚úÖ PASS' : '‚ùå FAIL'; ?>
                                        </span>
                                        <span style="margin-left: 10px; font-size: 13px;"><?php echo esc_html($card['test_results']['message']); ?></span>
                                    </div>
                                    <div style="font-size: 11px; color: #666;">
                                        <?php echo esc_html($card['test_results']['timestamp']); ?>
                                    </div>
                                </div>
                            <?php else: ?>
                                <p style="margin: 0; color: #666; font-style: italic;">No test results yet</p>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
            <?php endforeach; ?>
        <?php endif; ?>
    </div>
    
    <!-- Storage Information -->
    <div class="card" style="margin-top: 30px; padding: 15px; background: #f0f6fc; border: 1px solid #c3d4e4;">
        <h3>Storage Information</h3>
        <p><strong>Storage Type:</strong> Server Storage (WordPress Options Table)</p>
        <p><strong>Total Cards:</strong> <?php echo count($saved_cards); ?></p>
        <p><strong>Option Key:</strong> <code>wpforo_ai_test_cards</code></p>
        <p class="description">All cards are stored in the WordPress database and persist between sessions.</p>
    </div>
</div>

<style>
.card {
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: box-shadow 0.2s ease;
    width: 100%;
    max-width: none !important; /* Override WordPress default */
}

.card:hover {
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.button-link-delete:hover {
    color: #a00 !important;
    text-decoration: underline;
}

.cards-container {
    max-width: 100%;
}

/* Horizontal form elements styling */
.horizontal-form {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
}

.form-group {
    display: flex;
    align-items: center;
    gap: 5px;
}

.checkbox-group {
    display: flex;
    gap: 15px;
    align-items: center;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
}

.form-label {
    font-weight: 600;
    white-space: nowrap;
}

select, input[type="checkbox"] {
    padding: 6px;
    border: 1px solid #ddd;
    border-radius: 3px;
}

select {
    min-width: 120px;
}

.form-actions {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-left: auto;
}

.card-id {
    font-size: 11px;
    color: #666;
    white-space: nowrap;
}

/* Responsible styles */
@media (max-width: 1024px) {
    .horizontal-form {
        gap: 15px;
    }
    
    .checkbox-group {
        gap: 10px;
    }
}

@media (max-width: 782px) {
    .card {
        margin-left: -20px;
        margin-right: -20px;
        border-left: none;
        border-right: none;
        border-radius: 0;
    }
    
    .horizontal-form {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
    }
    
    .form-group, .checkbox-group {
        width: 100%;
        justify-content: space-between;
    }
    
    .form-actions {
        margin-left: 0;
        justify-content: flex-end;
        width: 100%;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
    }
    
    select {
        min-width: 150px;
    }
}

@media (max-width: 480px) {
    .checkbox-group {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .form-group {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }
    
    .form-label {
        margin-bottom: 2px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Unsaved changes script loaded - testing click events');
    
    // Track if any test is currently running
    var testIsRunning = false;
    
    // Handle Run Test button clicks
    document.querySelectorAll('.run-test-button').forEach(function(button) {
        button.addEventListener('click', function() {
            var cardId = this.dataset.cardId;
            var button = this;
            var resultsContainer = this.closest('.card').querySelector('.test-results');
            
            // Prevent multiple clicks if test is already running
            if (button.disabled) {
                return;
            }
            
            // Show loading state
            var originalText = button.textContent;
            button.textContent = 'Running...';
            button.disabled = true;
            
            // Set global flag
            testIsRunning = true;
            document.querySelectorAll('.run-test-button').forEach(function(btn) {
                if (btn !== button) {
                    btn.disabled = true;
                    btn.textContent = 'Waiting Queue...';
                }
            });
            
            // Send AJAX request
            jQuery.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action: 'wpforo_ai_run_test',
                    nonce: '<?php echo wp_create_nonce("wpforo_ai_test_nonce"); ?>',
                    card_id: cardId
                },
                success: function(response) {
                    if (response.success) {
                        // Update the results display
                        var results = response.data;
                        resultsContainer.style.display = 'block';
                        resultsContainer.innerHTML = `
                            <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #646970;">Test Results</h4>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-weight: bold; color: ${results.success ? '#46b450' : '#dc3232'};">
                                        ${results.success ? '‚úÖ PASS' : '‚ùå FAIL'}
                                    </span>
                                    <span style="margin-left: 10px; font-size: 13px;">${results.message}</span>
                                </div>
                                <div style="font-size: 11px; color: #666;">
                                    ${results.timestamp}
                                </div>
                            </div>
                        `;
                        
                        // Show success message
                        jQuery(resultsContainer).before('<div class="notice notice-success is-dismissible"><p>Test completed successfully!</p></div>');
                    } else {
                        jQuery(resultsContainer).before('<div class="notice notice-warning is-dismissible"><p>' + response.data + '</p></div>');
                    }
                },
                error: function(xhr, status, error) {
                    jQuery(resultsContainer).before('<div class="notice notice-error is-dismissible"><p>Test error: ' + error + '</p></div>');
                },
                complete: function() {
                    // Reset button states
                    testIsRunning = false;
                    document.querySelectorAll('.run-test-button').forEach(function(btn) {
                        btn.disabled = false;
                        btn.textContent = 'Run Test';
                    });
                    
                    // Auto-remove notices after 5 seconds
                    setTimeout(function() {
                        jQuery('.notice').fadeOut(300, function() {
                            jQuery(this).remove();
                        });
                    }, 5000);
                }
            });
        });
    });
    
    // Track form changes and show/hide unsaved changes indicator
    document.querySelectorAll('.moderation-form').forEach(function(form) {
         console.log('Raw data-original-values:', form.dataset.originalValues);
        
        try {
            var originalValues = JSON.parse(form.dataset.originalValues);
            // console.log('Parsed original values:', originalValues);
            // console.log('Type field:', originalValues.type);
            // console.log('Approve field:', originalValues.approve);
            // console.log('All keys:', Object.keys(originalValues));
        } catch (e) {
            console.error('Error parsing JSON:', e);
            return;
        }
        
        var indicator = form.querySelector('.unsaved-changes-indicator');
        var saveButton = form.querySelector('.save-button');
        
        // Function to check if form has changes
        function checkForChanges() {
            var hasChanges = false;
            
            // console.log('Checking for changes...');
            
            // Check dropdowns
            form.querySelectorAll('select.form-field').forEach(function(select) {
                var currentValue = select.value;
                var originalValue = originalValues[select.name];
                // console.log('Dropdown', select.name, 'current:', currentValue, 'original:', originalValue);
                if (currentValue !== originalValue) {
                    hasChanges = true;
                    // console.log('Dropdown change detected!');
                }
            });
            
            // Check checkboxes
            form.querySelectorAll('input[type="checkbox"].form-field').forEach(function(checkbox) {
                var isChecked = checkbox.checked;
                var originalValue = originalValues[checkbox.name];
                // console.log('Checkbox', checkbox.name, 'checked:', isChecked, 'original:', originalValue);
                if ((isChecked && originalValue != 1) || (!isChecked && originalValue == 1)) {
                    hasChanges = true;
                    // console.log('Checkbox change detected!');
                }
            });
            
            // Check text inputs
            form.querySelectorAll('input[type="text"].form-field').forEach(function(textInput) {
                var currentValue = textInput.value;
                var originalValue = originalValues[textInput.name];
                // console.log('Text input', textInput.name, 'current:', currentValue, 'original:', originalValue);
                if (currentValue !== originalValue) {
                    hasChanges = true;
                    // console.log('Text input change detected!');
                }
            });
            
            console.log('Has changes:', hasChanges);
            
            // Update UI
            if (hasChanges) {
                indicator.style.display = 'inline';
                form.closest('.card').style.borderLeft = '4px solid #dc3232';
                saveButton.classList.add('button-secondary');
                saveButton.classList.remove('button-primary');
                // console.log('Showing unsaved changes indicator');
            } else {
                indicator.style.display = 'none';
                form.closest('.card').style.borderLeft = '';
                saveButton.classList.add('button-primary');
                saveButton.classList.remove('button-secondary');
                // console.log('Hiding unsaved changes indicator');
            }
        }
        
        // Listen for click events on checkboxes and change events on selects
        form.querySelectorAll('input[type="checkbox"].form-field').forEach(function(checkbox) {
            checkbox.addEventListener('click', checkForChanges);
            checkbox.addEventListener('change', checkForChanges);
        });
        
        form.querySelectorAll('select.form-field').forEach(function(select) {
            select.addEventListener('change', checkForChanges);
            select.addEventListener('click', checkForChanges);
        });
        
        // Also listen for input events for real-time feedback
        form.addEventListener('input', checkForChanges);
        form.addEventListener('change', checkForChanges);
        
        // Check initially with a slight delay to ensure DOM is fully ready
        setTimeout(function() {
            // console.log('Initial check after delay - form fields:');
            // form.querySelectorAll('.form-field').forEach(function(field) {
            //     console.log('Field:', field.name, 'Value:', field.type === 'checkbox' ? field.checked : field.value);
            // });
            checkForChanges();
        }, 300);
        
        // Handle form submission to reset changes
        // Function to get current form values as they would be saved
        function getCurrentFormValues() {
            var currentValues = {
                title_content: '',
                post_content: '',
                type: '',
                approve: 0,
                delete_user: 0,
                delete_content: 0,
                unmute: 'manually'
            };
            
            form.querySelectorAll('.form-field').forEach(function(field) {
                if (field.type === 'checkbox') {
                    if (field.name === 'approve') currentValues.approve = field.checked ? 1 : 0;
                    if (field.name === 'delete_user') currentValues.delete_user = field.checked ? 1 : 0;
                    if (field.name === 'delete_content') currentValues.delete_content = field.checked ? 1 : 0;
                } else if (field.type === 'text') {
                    if (field.name === 'title_content') currentValues.title_content = field.value;
                    if (field.name === 'post_content') currentValues.post_content = field.value;
                } else {
                    if (field.name === 'type') currentValues.type = field.value;
                    if (field.name === 'unmute') currentValues.unmute = field.value;
                }
            });
            
            return currentValues;
        }
        
        // Update the checkForChanges function to compare current form state with saved server state
        var originalCheckForChanges = checkForChanges;
        checkForChanges = function() {
            var currentValues = getCurrentFormValues();
            var hasChanges = false;
            
            // console.log('Comparing current form values with saved server values:');
            // console.log('Current:', currentValues);
            // console.log('Saved:', originalValues);

            if (currentValues.title_content !== originalValues.title_content) {
                hasChanges = true;
                console.log('Title content change detected');
            }
            
            if (currentValues.post_content !== originalValues.post_content) {
                hasChanges = true;
                console.log('Post content change detected');
            }

            // Compare each value
            if (currentValues.type !== originalValues.type) {
                hasChanges = true;
                console.log('Type change detected');
            }
            if (currentValues.approve !== originalValues.approve) {
                hasChanges = true;
                console.log('Approve change detected');
            }
            if (currentValues.delete_user !== originalValues.delete_user) {
                hasChanges = true;
                console.log('Delete user change detected');
            }
            if (currentValues.delete_content !== originalValues.delete_content) {
                hasChanges = true;
                console.log('Delete content change detected');
            }
            if (currentValues.unmute !== originalValues.unmute) {
                hasChanges = true;
                console.log('Unmute change detected');
            }
            
            console.log('Has unsaved changes:', hasChanges);
            
            // Update UI
            if (hasChanges) {
                indicator.style.display = 'inline';
                form.closest('.card').style.borderLeft = '4px solid #dc3232';
                saveButton.classList.add('button-secondary');
                saveButton.classList.remove('button-primary');
                // console.log('Showing unsaved changes indicator');
            } else {
                indicator.style.display = 'none';
                form.closest('.card').style.borderLeft = '';
                saveButton.classList.add('button-primary');
                saveButton.classList.remove('button-secondary');
                // console.log('Hiding unsaved changes indicator');
            }
        };
        
        // Handle form submission - update hidden fields with correct values before submission
        // Form submission now works automatically since field names match database structure
        form.addEventListener('submit', function(e) {
            console.log('Form submitted with field names matching database structure');
            return true;
        });
    });
});
</script>
<?php
}


/**
 * 
 * 
 * 
 * ALL FUNCTIONS SECTION
 * 
 * 
 * 
 */

/**
 * Save a new card to server storage
 */
function wpforo_ai_test_save_card($title) {
    $cards = get_option('wpforo_ai_test_cards', []);
    $card_id = time() . '_' . wp_rand(1000, 9999);
    
    $cards[$card_id] = [
        'title' => $title,
        'content' => [
            'title_content' => '',
            'post_content' => '',
            'type' => 'topic',
            'approve' => 0,
            'delete_user' => 0,
            'delete_content' => 0,
            'unmute' => 'manually'
        ],
        'created' => current_time('mysql'),
        'modified' => current_time('mysql'),
        'test_results' => null
    ];
    
    update_option('wpforo_ai_test_cards', $cards);
}

/**
 * Delete a card from server storage
 */
function wpforo_ai_test_delete_card($card_id) {
    $cards = get_option('wpforo_ai_test_cards', []);
    if (isset($cards[$card_id])) {
        unset($cards[$card_id]);
        update_option('wpforo_ai_test_cards', $cards);
    }
}

/**
 * Update card content
 */
function wpforo_ai_test_update_card($card_id, $content) {
    $cards = get_option('wpforo_ai_test_cards', []);
    if (isset($cards[$card_id])) {
        $cards[$card_id]['content'] = $content;
        $cards[$card_id]['modified'] = current_time('mysql');
        update_option('wpforo_ai_test_cards', $cards);
    }
}

/**
 * Get all saved cards
 */
function wpforo_ai_test_get_cards() {
    return get_option('wpforo_ai_test_cards', []);
}



// Register AJAX handlers for test functionality
add_action('wp_ajax_wpforo_ai_run_test', 'wpforo_ai_run_test_ajax');

/**
 * AJAX handler for running tests
 */
function wpforo_ai_run_test_ajax() {
    // Check nonce and permissions
    if (!check_ajax_referer('wpforo_ai_test_nonce', 'nonce', false) || ( !current_user_can('manage_options') && !current_user_can('wpforo_ai_can_access_moderation') )) {
        wp_die('Unauthorized', 403);
    }
    
    $card_id = sanitize_text_field($_POST['card_id']);
    
    // Check if function is already running
    $is_running = get_transient('wpforo_ai_test_running');
    if ($is_running) {
        // Add to queue
        $queue = get_option('wpforo_ai_test_queue', []);
        $queue[] = $card_id;
        update_option('wpforo_ai_test_queue', $queue);
        
        wp_send_json_error('Test function is already running. Your test has been queued.');
    }
    
    // Set running lock with 2-minute timeout
    set_transient('wpforo_ai_test_running', true, 120);
    
    try {
        $test_results = wpforo_ai_run_test($card_id);
        
        // Process queue if any
        wpforo_ai_process_test_queue();
        
        wp_send_json_success($test_results);
    } catch (Exception $e) {
        // Clear the lock on error
        delete_transient('wpforo_ai_test_running');
        wp_send_json_error('Test failed: ' . $e->getMessage());
    }
}

/**
 * Process test queue after current test completes
 */
function wpforo_ai_process_test_queue() {
    $queue = get_option('wpforo_ai_test_queue', []);
    
    if (empty($queue)) {
        // No queue items, clear the lock
        delete_transient('wpforo_ai_test_running');
        return;
    }
    
    // Get next item from queue
    $card_id = array_shift($queue);
    update_option('wpforo_ai_test_queue', $queue);
    
    // Run test for the next queued item
    if ($card_id) {
        wpforo_ai_run_test($card_id);
        
        // Continue processing queue recursively
        wpforo_ai_process_test_queue();
    } else {
        // Queue is empty, clear the lock
        delete_transient('wpforo_ai_test_running');
    }
}



function wpforo_ai_test_factory_create_user(){
    // Arrays of popular American female first names
    $first_names = [
        'Emma', 'Olivia', 'Ava', 'Isabella', 'Sophia', 'Charlotte', 'Mia', 'Amelia', 
        'Harper', 'Evelyn', 'Abigail', 'Emily', 'Elizabeth', 'Mila', 'Ella', 'Avery',
        'Sofia', 'Camila', 'Aria', 'Scarlett', 'Victoria', 'Madison', 'Luna', 'Grace',
        'Chloe', 'Penelope', 'Layla', 'Riley', 'Zoey', 'Nora', 'Lily', 'Eleanor',
        'Hannah', 'Lillian', 'Addison', 'Aubrey', 'Ellie', 'Stella', 'Natalie', 'Zoe',
        'Leah', 'Hazel', 'Violet', 'Aurora', 'Savannah', 'Audrey', 'Brooklyn', 'Bella',
        'Claire', 'Skylar', 'Lucy', 'Paisley', 'Everly', 'Anna', 'Caroline', 'Nova',
        'Genesis', 'Emilia', 'Kennedy', 'Samantha', 'Maya', 'Willow', 'Kinsley', 'Naomi',
        'Aaliyah', 'Elena', 'Sarah', 'Ariana', 'Allison', 'Gabriella', 'Alice', 'Madelyn',
        'Cora', 'Ruby', 'Eva', 'Serenity', 'Autumn', 'Adeline', 'Hailey', 'Gianna',
        'Valentina', 'Isla', 'Eliana', 'Quinn', 'Nevaeh', 'Ivy', 'Sadie', 'Piper',
        'Lydia', 'Alexa', 'Josephine', 'Emery', 'Julia', 'Delilah', 'Arianna', 'Vivian',
        'Kaylee', 'Sophie', 'Brielle', 'Madeline'
    ];

    // Arrays of common worldwide surnames
    $last_names = [
        'Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Miller', 'Davis',
        'Wilson', 'Anderson', 'Thomas', 'Taylor', 'Moore', 'Jackson', 'Martin', 'Lee',
        'Thompson', 'White', 'Harris', 'Clark', 'Lewis', 'Robinson', 'Walker',
        'Young', 'Allen', 'King', 'Wright', 'Scott', 'Hill', 'Flores',
        'Green', 'Adams', 'Nelson', 'Baker', 'Hall', 'Campbell', 'Mitchell',
        'Carter', 'Roberts', 'Phillips', 'Evans', 'Turner', 'Parker',
        'Edwards', 'Collins', 'Stewart', 'Morris', 'Murphy',
        'Cook', 'Rogers', 'Morgan', 'Cooper', 'Peterson', 'Bailey',
        'Reed', 'Kelly', 'Howard', 'Kim', 'Cox', 'Ward', 'Richardson', 'Watson',
        'Brooks', 'Wood', 'James', 'Bennett', 'Gray', 'Hughes', 'Price', 'Sanders', 
        'Patel', 'Myers', 'Long', 'Ross', 'Foster', 'Garcia', 'Rodriguez', 'Martinez',
        'Hernandez', 'Lopez', 'Ding', 'Perez', 'Dong', 'Ramirez', 'Gomez', 
        'Diaz', 'Cruz', 'Reyes', 'Morales', 'Ortiz', 'Ramos', 'Chavez', 'Ruiz', 
        'Jimenez'
    ];

    // Random selection
    $first_name = $first_names[array_rand($first_names)];
    $last_name = $last_names[array_rand($last_names)];
    $month = str_pad(rand(1, 12), 2, '0', STR_PAD_LEFT);
    $year = rand(1985, 2010);

    // Create username (first initial + last name + bday month, year)
    $username = strtolower($first_name .'_'. $last_name .'_'. $month . '_' .$year);
    
    // Create email
    $email = $username . '@example.com';

    // Create user data
    $user_data = [
        'user_login'    => $username,
        'user_email'    => $email,
        'user_pass'     => 'password',
        'first_name'    => $first_name,
        'last_name'     => $last_name,
        'display_name'  => $first_name . ' ' . $last_name,
        'role'          => 'subscriber'
    ];

    // Insert user
    $user_id = wp_insert_user($user_data);

    if (is_wp_error($user_id)) {
        return [
            'success' => false,
            'user_id' => null,
            'message' => 'üè≠ ‚ùå Failed to create user: ' . $user_id->get_error_message(),
            'user_data' => $user_data
        ];
    }

    // Add birth date as user meta
    $birth_date = $year . '-' . $month . '-' . str_pad(rand(1, 28), 2, '0', STR_PAD_LEFT);
    update_user_meta($user_id, 'birth_date', $birth_date);

    return [
        'success' => true,
        'user_id' => $user_id,
        'username' => $username,
        'email' => $email,
        'password' => $user_data['user_pass'],
        'birth_date' => $birth_date,
        'full_name' => $first_name . ' ' . $last_name,
        'message' => 'üè≠  ‚úÖ Created new user. User ID: ' .$user_id . ' User Name: ' . $username
    ];
}

function wpforo_ai_test_factory_create_topic($user_id, $topic_title, $post_content, $forum_id = null){

    // Get wpForo instance
    $wpforo = WPF();

    // If no forum ID provided, find the first available forum
    if (!$forum_id) {
        $forums = $wpforo->forum->get_forums(['type' => 'forum', 'status' => 1]);
        if (empty($forums)) {
            // Try to find any forum including categories
            $forums = $wpforo->forum->get_forums(['status' => 1]);
        }
        
        if (empty($forums)) {
            return [
                'success' => false,
                'message' => 'üè≠ ‚ùå No forums found to post in'
            ];
        }
        
        // Use the first available forum
        $forum_id = $forums[0]['forumid'];
    }

    // Create topic data
    $topic_data = [
        'forumid' => $forum_id,
        'title' => $topic_title,
        'body' => $post_content,
        'created' => current_time('mysql', 1),
        'userid' => $user_id,
        'name' => get_userdata($user_id)->display_name,
        'email' => get_userdata($user_id)->user_email,
        'status' => 0, // Published
        'private' => 0,
        'type' => 0, // Normal topic
        'slug' => sanitize_title($topic_title),
        'meta_key' => '',
        'meta_desc' => '',
        'has_attach' => 0,
        'posts' => 1,
        'votes' => 0,
        'answers' => 0,
        'views' => 0
    ];

    // Create the topic
    $topic_id = $wpforo->topic->add($topic_data);

    if (is_wp_error($topic_id)) {
        return [
            'success' => false,
            'topic_id' => null,
            'message' => 'üè≠ ‚ùå Failed to create topic: ' . $topic_id->get_error_message(),
            'topic_data' => $topic_data
        ];
    }

    // Also create the first post for the topic
    $post_data = [
        'forumid' => $forum_id,
        'topicid' => $topic_id,
        'title' => $topic_title,
        'body' => $post_content,
        'created' => current_time('mysql', 1),
        'userid' => $user_id,
        'name' => get_userdata($user_id)->display_name,
        'email' => get_userdata($user_id)->user_email,
        'status' => 0,
        'private' => 0,
        'is_first_post' => 1,
        'is_answer' => 0
    ];

    $post_id = $wpforo->post->add($post_data);

    if (is_wp_error($post_id)) {
        // Clean up the topic if post creation failed
        $wpforo->topic->delete($topic_id);
        
        return [
            'success' => false,
            'topic_id' => null,
            'post_id' => null,
            'message' => 'üè≠ ‚ùå Failed to create Topic Post: ' . $post_id->get_error_message(),
            'topic_data' => $topic_data,
            'post_data' => $post_data
        ];
    }

    return [
        'success' => true,
        'topic_id' => $topic_id,
        'post_id' => $post_id,
        'forum_id' => $forum_id,
        'user_id' => $user_id,
        'title' => $topic_title,
        'content' => $post_content,
        'forum_name' => $wpforo->forum->get_forum($forum_id)['title'] ?? 'Unknown Forum',
        'message' => 'üè≠ ‚úÖ Successfully created Topic. Topic ID: ' . $topic_id . ' | Post ID: ' . $post_id . ' | User ID: ' . $user_id
    ];
}


function wpforo_ai_test_factory_create_post($user_id, $topic_id, $post_content){

    // Get the topic to ensure it exists and get forum information
    $topic = WPF()->topic->get_topic($topic_id);
    if (!$topic) {
        return [
            'success' => false,
            'message' => 'üè≠ ‚ùå Topic not found with ID: ' . $topic_id
        ];
    }

    // Prepare the post data array
    $post_data = array(
        'topicid' => $topic_id,
        'forumid' => $topic['forumid'],
        'userid' => $user_id,
        'title' => 'RE: ' . $topic['title'], // Standard reply title format
        'body' => $post_content,
        'created' => current_time('mysql', 1),
        'status' => 0, // Default status (0 = published)
        'private' => $topic['private'] ? 1 : 0, // Inherit private status from topic
        'name' => '', // Will be populated from user data
        'email' => '', // Will be populated from user data
        'parentid' => 0 // Root post (not a reply to another post)
    );

    // Get user information if available
    if ($user_id > 0) {
        $user = get_userdata($user_id);
        if ($user) {
            $post_data['name'] = $user->display_name;
            $post_data['email'] = $user->user_email;
        }
    }

    // Use wpForo's built-in post creation method
    $post_id = WPF()->post->add($post_data);

    if ($post_id) {
        // Clear any notices that might have been generated
        WPF()->notice->clear();
        
        // Get forum info for return
        $forum_info = WPF()->forum->get_forum($topic['forumid']);
        $forum_name = $forum_info ? $forum_info['title'] : 'Unknown Forum';
        
        return [
            'success' => true,
            'topic_id' => $topic_id,
            'post_id' => $post_id,
            'forum_id' => $topic['forumid'],
            'user_id' => $user_id,
            'title' => 'RE: ' . $topic['title'],
            'content' => $post_content,
            'forum_name' => $forum_name,
            'message' => 'üè≠ ‚úÖ Successfully created Post. Topic ID: ' . $topic_id . ' | Post ID: ' . $post_id . ' | User ID: ' . $user_id
        ];
    } else {
        // Log any errors
        $notices = WPF()->notice->get_notices();
        $error_message = 'üè≠ ‚ùå Failed to create post in topic: ' . $topic_id;
        
        if (!empty($notices) && is_array($notices)) {
            foreach ($notices as $notice) {
                if (is_array($notice) && isset($notice['text'])) {
                    error_log('WPForo Post Creation Error: ' . $notice['text']);
                    $error_message .= ' | Error: ' . $notice['text'];
                }
            }
        }
        
        return [
            'success' => false,
            'message' => $error_message
        ];
    }
}

function wpforo_ai_test_factory_edit_topic($user_id, $topic_id, $first_post_id, $updated_topic_title, $updated_post_context){
    global $wpforo_ai_original_user_id;
    
    
    // Get wpForo instance
    $wpforo = WPF();

    // First, try to get the existing topic to verify it exists
    $existing_topic = $wpforo->topic->get_topic($topic_id, false);
    if (!$existing_topic) {
        return [
            'success' => false,
            'topic_id' => $topic_id,
            'post_id' => $first_post_id,
            'message' => 'üè≠ ‚ùå Topic not found with ID: ' . $topic_id
        ];
    }

    // Check if the first post exists
    $existing_post = $wpforo->post->get_post($first_post_id, false);
    if (!$existing_post) {
        return [
            'success' => false,
            'topic_id' => $topic_id,
            'post_id' => $first_post_id,
            'message' => 'üè≠ ‚ùå First post not found with ID: ' . $first_post_id
        ];
    }

    // Verify that the post belongs to the topic
    if ($existing_post['topicid'] != $topic_id) {
        return [
            'success' => false,
            'topic_id' => $topic_id,
            'post_id' => $first_post_id,
            'message' => 'üè≠ ‚ùå Post ' . $first_post_id . ' does not belong to topic ' . $topic_id
        ];
    }

    // Update the topic - wpForo topic->edit() takes an associative array
    // $topic_update_data = [
    //     'topicid' => $topic_id,
    //     'title' => $updated_topic_title,
    //     'slug' => sanitize_title($updated_topic_title)
    // ];
// 
    // $topic_update_result = $wpforo->topic->edit($topic_update_data);
// 
    // if (is_wp_error($topic_update_result)) {
    //     // Restore original user
    //     wp_set_current_user($wpforo_ai_original_user_id);
    //     return [
    //         'success' => false,
    //         'topic_id' => $topic_id,
    //         'post_id' => $first_post_id,
    //         'message' => 'üè≠ ‚ùå Failed to update topic: ' . $topic_update_result->get_error_message(),
    //         'topic_update_data' => $topic_update_data
    //     ];
    // }

    // Update the first post - wpForo post->edit() takes an associative array
    $post_update_data = [
        'postid' => $first_post_id,
        'title' => $updated_topic_title,
        'body' => $updated_post_context, // Using title as body content for consistency with create function
    ];

    $post_update_result = $wpforo->post->edit($post_update_data);

    if (is_wp_error($post_update_result)) {
        // Try to revert the topic update if post update fails
        $wpforo->topic->edit([
            'topicid' => $topic_id,
            'title' => $existing_topic['title'], 
            'slug' => $existing_topic['slug']
        ]);
        
        return [
            'success' => false,
            'topic_id' => $topic_id,
            'post_id' => $first_post_id,
            'message' => 'üè≠ ‚ùå Failed to update post: ' . $post_update_result->get_error_message(),
            'post_update_data' => $post_update_data
        ];
    }

    
    return [
        'success' => true,
        'topic_id' => $topic_id,
        'post_id' => $first_post_id,
        'user_id' => $user_id,
        'original_topic_title' => $existing_topic['title'],
        'updated_topic_title' => $updated_topic_title,
        'original_post_context' => $existing_post['body'],
        '$updated_post_context' => $updated_post_context,
        'forum_id' => $existing_topic['forumid'],
        'forum_name' => $wpforo->forum->get_forum($existing_topic['forumid'])['title'] ?? 'Unknown Forum',
        'message' => 'üè≠ ‚úÖ Successfully edited Topic as User ' . $user_id . '. Topic ID: ' . $topic_id . ' | Post ID: ' . $first_post_id
    ];

}

function wpforo_ai_test_factory_edit_post($user_id, $post_id, $updated_post_context){
    global $wpforo_ai_original_user_id;
    
    
    // Get wpForo instance
    $wpforo = WPF();

    // First, try to get the existing post to verify it exists
    $existing_post = $wpforo->post->get_post($post_id);
    if (!$existing_post) {
        return [
            'success' => false,
            'post_id' => $post_id,
            'message' => 'üè≠ ‚ùå Post not found with ID: ' . $post_id
        ];
    }

    // Verify that the user owns the post (or has permission to edit)
    if ($existing_post['userid'] != $user_id) {
        // Check if current user has moderator/admin privileges to edit other users' posts
        $current_user = wp_get_current_user();
        if (!current_user_can('administrator') && !current_user_can('moderate')) {
            return [
                'success' => false,
                'post_id' => $post_id,
                'message' => 'üè≠ ‚ùå Unknown error. User ' . $user_id . ' does not own post ' . $post_id . ' and lacks edit permissions'
            ];
        }
    }

    // Update the post - wpForo post->edit() takes an associative array
    $post_update_data = [
        'postid' => $post_id,
        'body' => $updated_post_context,
    ];

    $post_update_result = $wpforo->post->edit($post_update_data);

    if (is_wp_error($post_update_result)) {
        return [
            'success' => false,
            'post_id' => $post_id,
            'message' => 'üè≠ ‚ùå Failed to update post: ' . $post_update_result->get_error_message(),
            'post_update_data' => $post_update_data
        ];
    }

    // Get the associated topic and forum for context
    $topic = $wpforo->topic->get_topic($existing_post['topicid']);
    $forum = $wpforo->forum->get_forum($topic['forumid'] ?? 0);

    
    
    return [
        'success' => true,
        'post_id' => $post_id,
        'user_id' => $user_id,
        'original_post_body' => $existing_post['body'],
        'updated_post_body' => $updated_post_context,
        'topic_id' => $existing_post['topicid'],
        'topic_title' => $topic['title'] ?? 'Unknown Topic',
        'forum_id' => $topic['forumid'] ?? 0,
        'forum_name' => $forum['title'] ?? 'Unknown Forum',
        'message' => 'üè≠ ‚úÖ Successfully edited Post as User ' . $user_id . '. Post ID: ' . $post_id
    ];
}

function wpforo_ai_test_factory_assess_is_user_muted($user_id){
    sleep(1);
    global $wpdb;
    $table_name = $wpdb->prefix . 'wpforo_ai_muted_users';
    // Check if user already exists in muted users table
    $existing_record = $wpdb->get_row($wpdb->prepare(
        "SELECT id FROM $table_name WHERE user_id = %d", 
        $user_id
    ));

    // return true or false
    return $existing_record;
}

function wpforo_ai_test_factory_approve_penalty($post_id){
    WPF()->post->set_status($post_id, 0);
    // verification after 4 seconds to allow cache to clear
    sleep(4);
    $post = WPF()->post->get_post($post_id, false);

    if ($post && $post['status'] == 0){
        return [
            'success' => true,
            'message' => 'üè≠ ‚úÖ Successfully approved Post ' . $post_id
        ];
    }
    else {
        return [
            'success' => false,
            'message' => 'üè≠ ‚ùå Failed to approve Post ' . $post_id
        ];
    }
}

function wpforo_ai_test_factory_delete_content($post_id){
    $deleted = WPF()->post->delete($post_id, true, true,$empty, false);
    sleep(4);
    if ($deleted){
        return [
            'success' => true,
            'message' => 'üè≠ ‚úÖ Successfully deleted penalty post ID: ' . $post_id
        ];
    }
    else {
        return [
            'success' => false,
            'message' => 'üè≠ ‚ùå Failed to delete penalty post ID: ' . $post_id
        ];
    }
}

function wpforo_ai_test_factory_delete_user($user_id){
    // Delete the user
    // We use require_once to prevent the 'user deleted' hook from redirecting
    require_once(ABSPATH . 'wp-admin/includes/user.php');
    $delete_result = wp_delete_user($user_id);
    sleep(4);
    
    
    if ($delete_result) {
        return [
            'success' => true,
            'user_id' => $user_id,
            'message' => 'üè≠ ‚úÖ Successfully deleted user account. User ID: ' . $user_id . ' | Username: ' . $username
        ];
    } else {
        return [
            'success' => false,
            'user_id' => $user_id,
            'message' => 'üè≠ ‚ùå Failed to delete user account. User ID: ' . $user_id . ' | Username: ' . $username
        ];
    }
}

function wpforo_ai_test_factory_run_unmute_methods($user_id, $type) {
    if ($type == 'automatically') {
        wpforo_ai_delete_penalizing_topic_or_post_for_user($user_id);
        wpforo_ai_unmute_all_expired_muted_users();
    } else {
        wpforo_ai_delete_penalizing_topic_or_post_for_user($user_id);
        wpforo_ai_unmute_user($user_id);
    }
}


/**
 * 
 * 
 * 
 * RUN THE TEST 
 * Emojis used ü§ñ üè≠ ‚úÖ ‚ùå
 * 
 * 
 * 
 */

/**
 * Run test for a specific card
 */
function wpforo_ai_run_test($card_id) {
    // Check if wpForo is active
    if (!function_exists('WPF') || !is_plugin_active('wpforo-ai-moderation/wpforo-ai-moderation.php')) {
        return [
            'success' => false,
            'message' => 'üè≠ ‚ùå Either (or both) wpForo plugin or wpForo AI Moderation plugin is not active or not loaded'
        ];
    }


    $cards = get_option('wpforo_ai_test_cards', []);
    
    if (!isset($cards[$card_id])) {
        return [
            'success' => false,
            'message' => 'Card not found'
        ];
    }
    
    $card = $cards[$card_id];
    
    global $wpforo_ai_original_user_id;
    // Store original user ID for restoration
    $wpforo_ai_original_user_id = get_current_user_id();
    
    $test_result = [
        'success' => false,
        'message' => '',
        'timestamp' => current_time('mysql')
    ];
    $message = '';

    sleep(2);
    // Check if cron job is scheduled to run in under _ minutes
    $next_scheduled = wp_next_scheduled('wpforo_ai_job_cleanup');

    if ($next_scheduled && ($next_scheduled - time()) < 300) {
        // Cron job is scheduled to run in less than _ minutes
        $minutes_until = round(($next_scheduled - time()) / 60, 1);
        $test_result['message'] = $message = "üè≠ ‚ùå Cron job 'wpforo_ai_job_cleanup' is scheduled to run in {$minutes_until} minutes. The test could not be run. Allow the test adequate time to process. (Ease up buddy, take a short break until testing can resume üôÇ)";
        $test_result['success'] = false;
        
        
        // Save test results to card
        $cards[$card_id]['test_results'] = $test_result;
        update_option('wpforo_ai_test_cards', $cards);

        // Restore original user before returning
        wp_set_current_user($wpforo_ai_original_user_id);
        return $test_result;
    } else {
        // Cron job is not scheduled to run soon or not scheduled at all
        if ($next_scheduled) {
            $minutes_until = round(($next_scheduled - time()) / 60, 1);
            $message .= "üè≠ ‚úÖ Cron job 'wpforo_ai_job_cleanup' is scheduled to run in {$minutes_until} minutes. Test conditions are favorable.";
        } else {
            $message .= "üè≠ ‚úÖ Cron job 'wpforo_ai_job_cleanup' is not scheduled. This may be expected behavior.";
        }
    }


    /*
     *
     * Handle creating the new user. A new user is required per test.
     *  
     */
    $user_creation_result = wpforo_ai_test_factory_create_user();
    $message .= $user_creation_result['message'];
    
    if (!$user_creation_result['success']){
        $test_result['success'] = false;
        $test_result['message'] = $message;
        // Save test results to card
        $cards[$card_id]['test_results'] = $test_result;
        update_option('wpforo_ai_test_cards', $cards);

        // Restore original user before returning
        wp_set_current_user($wpforo_ai_original_user_id);
        return $test_result;
    }
    // set ID as the newly created user
    wp_set_current_user($user_creation_result['user_id']);


    /*
     * 
     * Handle content creation, depending on title content and post content, this will determine if the content should result in mute penalty for the test user
     * Topic and post updates will require the content to be approved by default, then edit
     * Warning: The default prompt and flags should be set for this test, and content passed should have "[FLAG] | [REVIEW] | [ALLOW]" in either title or post content
     * 
     */
    $creation_result = null;
    
    if ($card['content']['type'] === 'topic') {
        // Create a topic with the user
        $creation_result = wpforo_ai_test_factory_create_topic(
            $user_creation_result['user_id'],
            $card['content']['title_content'],
            $card['content']['post_content']
        );
        $message .= $creation_result['message'];
        
        if (!$creation_result['success']) {
            // return early
            $test_result['success'] = false;
            $test_result['message'] = $message;
            // Save test results to card
            $cards[$card_id]['test_results'] = $test_result;
            update_option('wpforo_ai_test_cards', $cards);

            // Restore original user before returning
            wp_set_current_user($wpforo_ai_original_user_id);
            return $test_result;
        }
        
        // wait for topic to be added and moderated
        sleep(10);
    
    } else if ($card['content']['type'] === 'post') {
        // Need to create a topic first, then a reply
        $topic_creation_result = wpforo_ai_test_factory_create_topic(
            $user_creation_result['user_id'],
            '[ALLOW] Test Topic for Reply - ' . date('Y-m-d H:i:s'),
            '[ALLOW] This is a test topic for reply creation'
        );
        $message .= $topic_creation_result['message'];


        // create the post
        if (!$topic_creation_result['success']) {
            // return early
            $test_result['success'] = false;
            $test_result['message'] = $message;
            // Save test results to card
            $cards[$card_id]['test_results'] = $test_result;
            update_option('wpforo_ai_test_cards', $cards);

            // Restore original user before returning
            wp_set_current_user($wpforo_ai_original_user_id);

            return $test_result;
        }
        // wait for moderation to approve topic
        sleep(10);

        $creation_result = wpforo_ai_test_factory_create_post(
            $user_creation_result['user_id'],
            $topic_creation_result['topic_id'],
            $card['content']['post_content']
        );
        $message .= $creation_result['message'];

        if (!$creation_result['success']) {
            // return early
            $test_result['success'] = false;
            $test_result['message'] = $message;
            // Save test results to card
            $cards[$card_id]['test_results'] = $test_result;
            update_option('wpforo_ai_test_cards', $cards);


            // Restore original user before returning
            wp_set_current_user($wpforo_ai_original_user_id);

            return $test_result;
        }
        // wait for moderation to approve post
        sleep(10);


    } else if ($card['content']['type'] === 'topic-edit') {
        // First create a topic with ALLOW content
        $topic_creation_result = wpforo_ai_test_factory_create_topic(
            $user_creation_result['user_id'],
            '[ALLOW] Original Topic - ' . date('Y-m-d H:i:s'),
            '[ALLOW] Original post content'
        );
        $message .= $topic_creation_result['message'];
        
        if (!$topic_creation_result['success']) {
             // return early
             $test_result['success'] = false;
             $test_result['message'] = $message;
             // Save test results to card
             $cards[$card_id]['test_results'] = $test_result;
             update_option('wpforo_ai_test_cards', $cards);

                // Restore original user before returning
            wp_set_current_user($wpforo_ai_original_user_id);

             return $test_result; 
        }

            // Wait for moderation to approve the content
            sleep(10);
            
            // Now edit the topic with the test content
            $creation_result = wpforo_ai_test_factory_edit_topic(
                $user_creation_result['user_id'],
                $topic_creation_result['topic_id'],
                $topic_creation_result['post_id'],
                $card['content']['title_content'],
                $card['content']['post_content']
            );
            $message .= $creation_result['message'];

            if (!$creation_result['success']) {
                // return early
                $test_result['success'] = false;
                $test_result['message'] = $message;
                // Save test results to card
                $cards[$card_id]['test_results'] = $test_result;
                update_option('wpforo_ai_test_cards', $cards);

                    // Restore original user before returning
                wp_set_current_user($wpforo_ai_original_user_id);

                return $test_result;
            }
        
    } else if ($card['content']['type'] === 'post-edit') {
        // First create a topic and post with ALLOW content
        $topic_creation_result = wpforo_ai_test_factory_create_topic(
            $user_creation_result['user_id'],
            '[ALLOW] Test Topic for Post Edit - ' . date('Y-m-d H:i:s'),
            '[ALLOW] Original post content'
        );
        $message .= $topic_creation_result['message'];
        
        if (!$topic_creation_result['success']) {
            // return early
            $test_result['success'] = false;
            $test_result['message'] = $message;
            // Save test results to card
            $cards[$card_id]['test_results'] = $test_result;
            update_option('wpforo_ai_test_cards', $cards);


            // Restore original user before returning
            wp_set_current_user($wpforo_ai_original_user_id);
            return $test_result;  
        }
        // wait for moderation
        sleep(10);

        $post_creation_result = wpforo_ai_test_factory_create_post(
            $user_creation_result['user_id'],
            $topic_creation_result['topic_id'],
            '[ALLOW] Original reply content'
        );
        $message .= $post_creation_result['message'];
        
        if (!$post_creation_result['success']) {
            // return early
            $test_result['success'] = false;
            $test_result['message'] = $message;
            // Save test results to card
            $cards[$card_id]['test_results'] = $test_result;
            update_option('wpforo_ai_test_cards', $cards);

            // Restore original user before returning
            wp_set_current_user($wpforo_ai_original_user_id);
            return $test_result;  
        }
        // Wait for moderation to approve the content
        sleep(10);
            
        // Now edit the post with the test content
        $creation_result = wpforo_ai_test_factory_edit_post(
            $user_creation_result['user_id'],
            $post_creation_result['post_id'],
            $card['content']['post_content']
        );
        $message .= $creation_result['message'];

        if (!$creation_result['success']) {
            // return early
            $test_result['success'] = false;
            $test_result['message'] = $message;
            // Save test results to card
            $cards[$card_id]['test_results'] = $test_result;
            update_option('wpforo_ai_test_cards', $cards);

            // Restore original user before returning
            wp_set_current_user($wpforo_ai_original_user_id);
            return $test_result;
        }

        sleep(10);
        

    } else {
        $message .= 'üè≠ ‚ùå Unknown card \'type\ ' . $card['content']['type'] . ' not recognized.';
        $test_result['message'] = $message;
        $test_result['success'] = false;

        // Restore original user before returning
        wp_set_current_user($wpforo_ai_original_user_id);
        return $test_result;
    }


    /*
    *
    * Assess Mute status. Is the user in the muted users table?
    *
    */

    $isMuted = wpforo_ai_test_factory_assess_is_user_muted($user_creation_result['user_id']);

    // Search for '[ALLOW]', '[FLAG]', or '[REVIEW]' in title_content and post_content
    $title_contains_allow = strpos($card['content']['title_content'], '[ALLOW]') !== false;
    $title_contains_flag = strpos($card['content']['title_content'], '[FLAG]') !== false;
    $title_contains_review = strpos($card['content']['title_content'], '[REVIEW]') !== false;
    
    $post_contains_allow = strpos($card['content']['post_content'], '[ALLOW]') !== false;
    $post_contains_flag = strpos($card['content']['post_content'], '[FLAG]') !== false;
    $post_contains_review = strpos($card['content']['post_content'], '[REVIEW]') !== false;

    // Add debug information about what was found
    $message .= " | Title contains: ";
    $message .= $title_contains_allow ? "[ALLOW] " : "";
    $message .= $title_contains_flag ? "[FLAG] " : "";
    $message .= $title_contains_review ? "[REVIEW] " : "";
    $message .= "| Post contains: ";
    $message .= $post_contains_allow ? "[ALLOW] " : "";
    $message .= $post_contains_flag ? "[FLAG] " : "";
    $message .= $post_contains_review ? "[REVIEW] " : "";

    if ($card['content']['type'] === 'topic' || $card['content']['type'] === 'topic-edit') {
        if ($title_contains_allow || $post_contains_allow || $title_contains_review || $post_contains_review){
            if ($isMuted) {
                $message .= 'üè≠ ‚ùå User was muted for topic. This is not expected behavior, user should not have been muted. Make sure title and post both contain [ALLOW]';
                // return early
                $test_result['success'] = false;
                $test_result['message'] = $message;
                // Save test results to card
                $cards[$card_id]['test_results'] = $test_result;
                update_option('wpforo_ai_test_cards', $cards);

                // Restore original user before returning
                wp_set_current_user($wpforo_ai_original_user_id);

                return $test_result;  
            }
            $message .= "üè≠ ‚úÖ User was NOT muted, this is expected behavior.";
        }
        if ($title_contains_flag|| $post_contains_flag){
            if (!$isMuted) {
                $message .= 'üè≠ ‚ùå User is NOT muted for topic. This is not expected behavior, user should have been muted.';
                // return early
                $test_result['success'] = false;
                $test_result['message'] = $message;
                // Save test results to card
                $cards[$card_id]['test_results'] = $test_result;
                update_option('wpforo_ai_test_cards', $cards);

                // Restore original user before returning
                wp_set_current_user($wpforo_ai_original_user_id);

                return $test_result;  
            }
            $message .= "üè≠ ‚úÖ User was muted, this is expected behavior.";
        }

    }
    else {
        if ($post_contains_allow){
            if ($isMuted) {
                $message .= 'üè≠ ‚ùå User was muted for post. This is not expected behavior, user should not have been muted.';
                // return early
                $test_result['success'] = false;
                $test_result['message'] = $message;
                // Save test results to card
                $cards[$card_id]['test_results'] = $test_result;
                update_option('wpforo_ai_test_cards', $cards);

                // Restore original user before returning
                wp_set_current_user($wpforo_ai_original_user_id);
                return $test_result;  
            }
            $message .= "üè≠ ‚úÖ User was NOT muted, this is expected behavior.";
        }
        if ($post_contains_flag){
            if (!$isMuted) {
                $message .= 'üè≠ ‚ùå User was NOT muted for post. This is not expected behavior, user should not have been muted.';
                // return early
                $test_result['success'] = false;
                $test_result['message'] = $message;
                // Save test results to card
                $cards[$card_id]['test_results'] = $test_result;
                update_option('wpforo_ai_test_cards', $cards);

                // Restore original user before returning
                wp_set_current_user($wpforo_ai_original_user_id);

                return $test_result;  
            }
            $message .= "üè≠ ‚úÖ User was muted, this is expected behavior.";
        }
    } 



    /*
     *
     * Handle setting the content status to approved. This occurs if a moderator took a look at the post, and approved it before unmuting the user. Unmuting the user would by default result in post deletion.
     *  
     */    
    if ($card['content']['approve'] == 1) {
        if ($isMuted){ 
            $approval_result = wpforo_ai_test_factory_approve_penalty($creation_result['post_id']);
            $message .= $approval_result['message'];
            
            if ($approval_result['success'] == false) {
                // return early
                $test_result['success'] = false;
                $test_result['message'] = $message;
                // Save test results to card
                $cards[$card_id]['test_results'] = $test_result;
                update_option('wpforo_ai_test_cards', $cards);

                // Restore original user before returning
                wp_set_current_user($wpforo_ai_original_user_id);

                return $test_result;  
            }

            
        }
        else {
            $message .= "üè≠ Skipped post approval since user was not muted. This is expected behavior.";
        }
    }
    else {
        $message .= "üè≠ Skipped post approval since it is not selected. This is expected behavior.";
    }

     /*
     *
     * Handle Deleting the User Content. This is done first, as deleting the account may inadvertently delete the content, removing test opportunity.
     * This occurs when the user becomes irritated by the post, and deletes is, or the moderator deletes it before handling user unmute.
     * 
     */

     if ($card['content']['delete_content'] == 1) {
        $content_deletion_result = wpforo_ai_test_factory_delete_content($creation_result['post_id']);
        $message .= $content_deletion_result['message'];
            
            if ($content_deletion_result['success'] == false) {
                // return early
                $test_result['success'] = false;
                $test_result['message'] = $message;
                // Save test results to card
                $cards[$card_id]['test_results'] = $test_result;
                update_option('wpforo_ai_test_cards', $cards);


                // Restore original user before returning
                wp_set_current_user($wpforo_ai_original_user_id);
                return $test_result;  
            }
     }
     else {
        $message .= "üè≠ Skipped content deletion since it is not selected. This is expected behavior.";
    }

     /*
      *
      * Handle Deleting the User Account. This occurs if the irate user deletes the account after the penalty, or the moderator deletes the account.
      * 
      */

      if ($card['content']['delete_user'] == 1) {
        $user_deletion_result = wpforo_ai_test_factory_delete_user($user_creation_result['user_id']);
        $message .= $user_deletion_result['message'];
            
            if ($user_deletion_result['success'] == false) {
                // return early
                $test_result['success'] = false;
                $test_result['message'] = $message;
                // Save test results to card
                $cards[$card_id]['test_results'] = $test_result;
                update_option('wpforo_ai_test_cards', $cards);

                // Restore original user before returning
            wp_set_current_user($wpforo_ai_original_user_id);

                return $test_result;  
            }
      } else {
        $message .= "üè≠ Skipped user deletion since it is not selected. This is expected behavior.";
      }

    
      /*
       *
       * Run the unmute test. Call either manual unmute and removal of the penalty, this mimicks moderato panel actions, or let the unmute occur "automatically" which mimicks cleanup cron job 
       * Assess whether the muted user was rm'd from the muted users table. They should have.
       * 
       */
      
       sleep(4);
       wpforo_ai_test_factory_run_unmute_methods($user_creation_result['user_id'] ,$card['content']['unmute']);

       /*
       *
       * Print out user and content data. Assess the test results. There are finite number of combinations. 
       * While this could be possibly assessed by an switch statement with combinations, the Admin must check the debug.log for any edge cases regardless due to the plugins automatic anti-braking mechanisms that prevent.
       * Assess test run manually.
       * 
       */
      sleep(2);
      $passed_final_check = true;
       // Is the user unmuted? Expected yes
       $is_still_muted = wpforo_ai_test_factory_assess_is_user_muted($user_creation_result['user_id']);
       if ($is_still_muted){
        $message .= 'üè≠ ‚ùå FINAL CHECKS: User is STILL muted after unmute/cleanup. This is not expected behavior, user should be unmuted at the end.';
        $passed_final_check = false;
       }
       else {
        $message .= "üè≠ ‚úÖ FINAL CHECKS: User is unmuted at the end, this is expected behavior.";
       }
       sleep(2);

       // If the post was approved and not deleted, is it approved? Expected yes.
       if ($card['content']['approve'] == 1 && $card['content']['delete_content'] == 0) {
        $post = WPF()->post->get_post($creation_result['post_id'], false);

            if ($post && $post['status'] == 0){
                $message .= "üè≠ ‚úÖ FINAL CHECKS: Post exists and is approved. This is expected behavior.";
            }
            else {
                $message .= "üè≠ ‚ùå FINAL CHECKS: Post either does not exists or is still unapproved. This is not expected behavior.";
                $passed_final_check = false;
            }
       }
       sleep(2);

       // If not approved and not deleted either, is it deleted automatically? Expected yes.
       if ($card['content']['approve'] == 0 && $card['content']['delete_content'] == 0) {
            $post = WPF()->post->get_post($creation_result['post_id']);

            if (!$post){
                $message .= "üè≠ ‚úÖ FINAL CHECKS: Post does not exist, has been deleted. This is expected behavior.";
            } else {
                $message .= "üè≠ ‚ùå FINAL CHECKS: Post STILL exists after unmute/cleanup. This is not expected behavior.";
                $passed_final_check = false;
            }
       }
    
    // Restore original user before returning
    wp_set_current_user($wpforo_ai_original_user_id);
    
    if ($passed_final_check){ 
        $message .= '‚úÖ Test completed. ‚úÖ Test PASSED!';
        $test_result['message'] = $message;
        $test_result['success'] = true;
    }
    else {
        $message .= '‚úÖ Test completed. ‚ùå But Test FAILED final checks.';
        $test_result['message'] = $message;
        $test_result['success'] = false;
    }
    return $test_result;
}
?>